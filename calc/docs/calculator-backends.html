<!DOCTYPE html>

<html>
<head>
  <title>calculator-backends.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="calculator-backends.html">
                calculator-backends.js
              </a>
            
              
              <a class="source" href="calculator-parser.html">
                calculator-parser.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>calculator-backends.js</h1>
<p>things to do with a simple calculator parser</p>
<p><a href="calculator-parser.html">calculator-parser.js</a> contains a simple parser.
It contains enough code that you can actually do some basic math with it.
But what else can you do with a parser?</p>
<p>This file contains seven different applications of
the calculator parser.</p>
<p><a href="../calculator.html">Try them out.</a></p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Code as data</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>1. Show the JSON</h3>
<p>Unmodified, the parser simply builds a tree describing the input
formula. This is called an abstract syntax tree, or AST.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">convertToJSON</span><span class="params">(code)</span> {</span>
    <span class="keyword">return</span> parse(code);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3>2. Convert to DOM</h3>
<p>Of course one of the nice things about JSON is that there are many ways to
display it. Here’s code that spits out DOM nodes that show how the program
would look in Scratch. (!)</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Helper function to create DOM elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">span</span><span class="params">(className, contents)</span> {</span>
    <span class="keyword">var</span> e = document.createElement(<span class="string">"span"</span>);
    e.className = className;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; contents.length; i++) {
        <span class="keyword">var</span> kid = contents[i];
        <span class="keyword">if</span> (<span class="keyword">typeof</span> kid === <span class="string">"string"</span>)
            kid = document.createTextNode(kid);
        e.appendChild(kid);
    }
    <span class="keyword">return</span> e;
}

<span class="function"><span class="keyword">function</span> <span class="title">convertToDOM</span><span class="params">(code)</span> {</span>
    <span class="keyword">var</span> fancyOperator = {
        <span class="string">"+"</span>: <span class="string">"+"</span>,
        <span class="string">"-"</span>: <span class="string">"\u2212"</span>,  <span class="comment">// &amp;minus;</span>
        <span class="string">"*"</span>: <span class="string">"\u00d7"</span>,  <span class="comment">// &amp;times;</span>
        <span class="string">"/"</span>: <span class="string">"\u00f7"</span>   <span class="comment">// &amp;divide;</span>
    };

    <span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">(obj)</span> {</span>
        <span class="keyword">switch</span> (obj.type) {
        <span class="keyword">case</span> <span class="string">"number"</span>:
            <span class="keyword">return</span> span(<span class="string">"num"</span>, [obj.value]);
        <span class="keyword">case</span> <span class="string">"+"</span>: <span class="keyword">case</span> <span class="string">"-"</span>: <span class="keyword">case</span> <span class="string">"*"</span>: <span class="keyword">case</span> <span class="string">"/"</span>:
            <span class="keyword">return</span> span(<span class="string">"expr"</span>, [convert(obj.left),
                                 fancyOperator[obj.type],
                                 convert(obj.right)]);
        <span class="keyword">case</span> <span class="string">"name"</span>:
            <span class="keyword">return</span> span(<span class="string">"var"</span>, [obj.id]);
        }
    }
    <span class="keyword">return</span> convert(parse(code));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>3. MathML output</h3>
<p>One more riff on this theme: How about generating beautiful MathML output?
(Unfortunately, some browsers still do not support MathML. Firefox does.)</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The hardest part of this was figuring out how to make MathML elements.
Here’s some code to help with that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> mathml = <span class="string">"http://www.w3.org/1998/Math/MathML"</span>;

<span class="function"><span class="keyword">function</span> <span class="title">mo</span><span class="params">(s)</span> {</span>
    <span class="keyword">var</span> e = document.createElementNS(mathml, <span class="string">"mo"</span>);
    <span class="keyword">var</span> t = document.createTextNode(s);
    e.appendChild(t);
    <span class="keyword">return</span> {prec: <span class="number">3</span>, element: e};
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create a new MathML DOM element of the specified type and contents.
<code>precedence</code> is used to determine whether or not to add parentheses around
any of the contents. If it’s <code>null</code>, no parentheses are added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">(name, precedence, contents)</span> {</span>
    <span class="keyword">var</span> e = document.createElementNS(mathml, name);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; contents.length; i++) {
        <span class="keyword">var</span> kid = contents[i];
        <span class="keyword">var</span> node;

        <span class="keyword">if</span> (<span class="keyword">typeof</span> kid === <span class="string">"string"</span>) {
            node = document.createTextNode(kid);
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>If precedence is non-null and higher than this child’s
precedence, wrap the child in parentheses.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (precedence !== <span class="literal">null</span>
                &amp;&amp; (kid.prec &lt; precedence
                    || (kid.prec == precedence &amp;&amp; i != <span class="number">0</span>)))
            {
                kid = make(<span class="string">"mrow"</span>, <span class="literal">null</span>, [mo(<span class="string">"("</span>), kid, mo(<span class="string">")"</span>)]);
            }
            node = kid.element;
        }
        e.appendChild(node);
    }
    <span class="keyword">if</span> (precedence === <span class="literal">null</span>)
        precedence = <span class="number">3</span>;
    <span class="keyword">return</span> {prec: precedence, element: e};
}

<span class="function"><span class="keyword">function</span> <span class="title">convertToMathML</span><span class="params">(code)</span> {</span>
    <span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">(obj)</span> {</span>
        <span class="keyword">switch</span> (obj.type) {
        <span class="keyword">case</span> <span class="string">"number"</span>:
            <span class="keyword">return</span> make(<span class="string">"mn"</span>, <span class="number">3</span>, [obj.value]);
        <span class="keyword">case</span> <span class="string">"name"</span>:
            <span class="keyword">return</span> make(<span class="string">"mi"</span>, <span class="number">3</span>, [obj.id]);
        <span class="keyword">case</span> <span class="string">"+"</span>:
            <span class="keyword">return</span> make(<span class="string">"mrow"</span>, <span class="number">1</span>, [convert(obj.left),
                                    make(<span class="string">"mo"</span>, <span class="number">3</span>, [<span class="string">"+"</span>]),
                                    convert(obj.right)]);
        <span class="keyword">case</span> <span class="string">"-"</span>:
            <span class="keyword">return</span> make(<span class="string">"mrow"</span>, <span class="number">1</span>, [convert(obj.left),
                                    make(<span class="string">"mo"</span>, <span class="number">3</span>, [<span class="string">"-"</span>]),
                                    convert(obj.right)]);
        <span class="keyword">case</span> <span class="string">"*"</span>:
            <span class="keyword">return</span> make(<span class="string">"mrow"</span>, <span class="number">2</span>, [convert(obj.left),
                                    convert(obj.right)]);
        <span class="keyword">case</span> <span class="string">"/"</span>:
            <span class="keyword">return</span> make(<span class="string">"mfrac"</span>, <span class="literal">null</span>, [convert(obj.left), convert(obj.right)]);
        }
    };
    <span class="keyword">var</span> e = convert(parse(code));
    <span class="keyword">return</span> make(<span class="string">"math"</span>, <span class="literal">null</span>, [e]);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2>Interpreters</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>4. Evaluate using floating-point numbers</h3>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Now let’s try actually performing some computation using the program we
read. This behaves like a stripped-down version of JavaScript <code>eval()</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">evaluateAsFloat</span><span class="params">(code)</span> {</span>
    <span class="keyword">var</span> variables = Object.create(<span class="literal">null</span>);
    variables.e = Math.E;
    variables.pi = Math.PI;

    <span class="function"><span class="keyword">function</span> <span class="title">evaluate</span><span class="params">(obj)</span> {</span>
        <span class="keyword">switch</span> (obj.type) {
        <span class="keyword">case</span> <span class="string">"number"</span>:  <span class="keyword">return</span> parseInt(obj.value);
        <span class="keyword">case</span> <span class="string">"name"</span>:  <span class="keyword">return</span> variables[obj.id] || <span class="number">0</span>;
        <span class="keyword">case</span> <span class="string">"+"</span>:  <span class="keyword">return</span> evaluate(obj.left) + evaluate(obj.right);
        <span class="keyword">case</span> <span class="string">"-"</span>:  <span class="keyword">return</span> evaluate(obj.left) - evaluate(obj.right);
        <span class="keyword">case</span> <span class="string">"*"</span>:  <span class="keyword">return</span> evaluate(obj.left) * evaluate(obj.right);
        <span class="keyword">case</span> <span class="string">"/"</span>:  <span class="keyword">return</span> evaluate(obj.left) / evaluate(obj.right);
        }
    }
    <span class="keyword">return</span> evaluate(parse(code));
}

assert.strictEqual(evaluateAsFloat(<span class="string">"2 + 2"</span>), <span class="number">4</span>);
assert.strictEqual(evaluateAsFloat(<span class="string">"3 * 4 * 5"</span>), <span class="number">60</span>);
assert.strictEqual(evaluateAsFloat(<span class="string">"5 * (2 + 2)"</span>), <span class="number">20</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3>5. Evaluate using precise fraction arithmetic</h3>
<p>Our little language is a tiny subset of JavaScript. But that doesn’t meant
it has to behave exactly like JavaScript. This is our language.
It can behave however we want.</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>So how about a calculator that does arbitrary precision arithmetic?
Let’s start by defining a <code>Fraction</code> class...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="keyword">var</span> BigInteger = require(<span class="string">'biginteger'</span>).BigInteger;

<span class="function"><span class="keyword">function</span> <span class="title">gcd</span><span class="params">(a, b)</span> {</span>
    <span class="keyword">while</span> (!b.isZero()) {
        <span class="keyword">var</span> tmp = a;
        a = b;
        b = tmp.remainder(b);
    }
    <span class="keyword">return</span> a;
}

<span class="function"><span class="keyword">function</span> <span class="title">Fraction</span><span class="params">(n, d)</span> {</span>
    <span class="keyword">if</span> (d === <span class="literal">undefined</span>)
        d = <span class="keyword">new</span> BigInteger(<span class="number">1</span>);
    <span class="keyword">var</span> x = gcd(n.abs(), d);  <span class="comment">// Simplify the fraction.</span>
    <span class="keyword">this</span>.n = n.divide(x);
    <span class="keyword">this</span>.d = d.divide(x);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>…and some Fraction methods. You learned these techniques in grade school,
though you may have forgotten some of them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Fraction.prototype = {
    add: <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Fraction(<span class="keyword">this</span>.n.multiply(x.d).add(x.n.multiply(<span class="keyword">this</span>.d)),
                            <span class="keyword">this</span>.d.multiply(x.d));
    },
    negate: <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Fraction(<span class="keyword">this</span>.n.negate(), <span class="keyword">this</span>.d);
    },
    sub: <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">this</span>.add(x.negate());
    },
    mul: <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Fraction(<span class="keyword">this</span>.n.multiply(x.n), <span class="keyword">this</span>.d.multiply(x.d));
    },
    div: <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Fraction(<span class="keyword">this</span>.n.multiply(x.d), <span class="keyword">this</span>.d.multiply(x.n));
    },
    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> ns = <span class="keyword">this</span>.n.toString(), ds = <span class="keyword">this</span>.d.toString();
        <span class="keyword">if</span> (ds === <span class="string">"1"</span>)
            <span class="keyword">return</span> ns;
        <span class="keyword">else</span>
            <span class="keyword">return</span> ns + <span class="string">"/"</span> + ds;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Now simply write an interpreter that computes the results using <code>Fraction</code>
objects rather than JavaScript numbers. It’s almost too easy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">evaluateAsFraction</span><span class="params">(code)</span> {</span>
    <span class="function"><span class="keyword">function</span> <span class="title">evaluate</span><span class="params">(obj)</span> {</span>
        <span class="keyword">switch</span> (obj.type) {
        <span class="keyword">case</span> <span class="string">"number"</span>:  <span class="keyword">return</span> <span class="keyword">new</span> Fraction(<span class="keyword">new</span> BigInteger(obj.value));
        <span class="keyword">case</span> <span class="string">"+"</span>:  <span class="keyword">return</span> evaluate(obj.left).add(evaluate(obj.right));
        <span class="keyword">case</span> <span class="string">"-"</span>:  <span class="keyword">return</span> evaluate(obj.left).sub(evaluate(obj.right));
        <span class="keyword">case</span> <span class="string">"*"</span>:  <span class="keyword">return</span> evaluate(obj.left).mul(evaluate(obj.right));
        <span class="keyword">case</span> <span class="string">"/"</span>:  <span class="keyword">return</span> evaluate(obj.left).div(evaluate(obj.right));
        <span class="keyword">case</span> <span class="string">"name"</span>:  <span class="keyword">throw</span> <span class="keyword">new</span> SyntaxError(<span class="string">"no variables in fraction mode, sorry"</span>);
        }
    }
    <span class="keyword">return</span> evaluate(parse(code));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Our tiny programming language is suddenly doing something JavaScript itself
doesn’t do: arithmetic with exact (not floating-point) results.  Tests:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>assert.strictEqual(evaluateAsFraction(<span class="string">"1 / 3"</span>).toString(), <span class="string">"1/3"</span>);
assert.strictEqual(evaluateAsFraction(<span class="string">"(2/3) * (3/2)"</span>).toString(), <span class="string">"1"</span>);
assert.strictEqual(evaluateAsFraction(<span class="string">"1/7 + 4/7 + 2/7"</span>).toString(), <span class="string">"1"</span>);
assert.strictEqual(
    evaluateAsFraction(<span class="string">"5996788328646786302319492 / 2288327879043508396784319"</span>).toString(),
    <span class="string">"324298349324/123749732893"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2>Compilers</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3>6. JavaScript function output</h3>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>This is just to show some very basic code generation.</p>
<p>Code generation for a real compiler will be harder, because the target
language is typically quite a bit different from the source language. Here
they are virtually identical, so code generation is very easy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">compileToJSFunction</span><span class="params">(code)</span> {</span>
    <span class="function"><span class="keyword">function</span> <span class="title">emit</span><span class="params">(ast)</span> {</span>
        <span class="keyword">switch</span> (ast.type) {
        <span class="keyword">case</span> <span class="string">"number"</span>:
            <span class="keyword">return</span> ast.value;
        <span class="keyword">case</span> <span class="string">"name"</span>:
            <span class="keyword">if</span> (ast.id !== <span class="string">"x"</span>)
                <span class="keyword">throw</span> SyntaxError(<span class="string">"only the name 'x' is allowed"</span>);
            <span class="keyword">return</span> ast.id;
        <span class="keyword">case</span> <span class="string">"+"</span>: <span class="keyword">case</span> <span class="string">"-"</span>: <span class="keyword">case</span> <span class="string">"*"</span>: <span class="keyword">case</span> <span class="string">"/"</span>:
            <span class="keyword">return</span> <span class="string">"("</span> + emit(ast.left) + <span class="string">" "</span> + ast.type + <span class="string">" "</span> + emit(ast.right) + <span class="string">")"</span>;
        }
    }

    <span class="keyword">return</span> Function(<span class="string">"x"</span>, <span class="string">"return "</span> + emit(parse(code)) + <span class="string">";"</span>);
}

assert.strictEqual(compileToJSFunction(<span class="string">"x*x - 2*x + 1"</span>)(<span class="number">1</span>), <span class="number">0</span>);
assert.strictEqual(compileToJSFunction(<span class="string">"x*x - 2*x + 1"</span>)(<span class="number">2</span>), <span class="number">1</span>);
assert.strictEqual(compileToJSFunction(<span class="string">"x*x - 2*x + 1"</span>)(<span class="number">3</span>), <span class="number">4</span>);
assert.strictEqual(compileToJSFunction(<span class="string">"x*x - 2*x + 1"</span>)(<span class="number">4</span>), <span class="number">9</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h3>7. Complex function output</h3>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>This one returns a JS function that operates on complex numbers.</p>
<p>This is a more advanced example of a compiler. It has a lowering phase
and a few simple optimizations.</p>
<p>The input string <code>code</code> is a formula, for example, <code>&quot;(z+1)/(z-1)&quot;</code>,
that uses a complex variable <code>z</code>.</p>
<p>This returns a JS function that takes two arguments, <code>z_re</code> and <code>z_im</code>,
the real and imaginary parts of a complex number <em>z</em>,
and returns an object <code>{re: some number, im: some number}</code>,
representing the complex result of computing the input formula,
(<em>z</em>+1)/(<em>z</em>-1). Here is the actual output in that case:</p>
<pre><code>(function anonymous(z_re, z_im) {
var t0 = (z_re+1);
var t1 = (z_re-1);
var t2 = (z_im*z_im);
var t3 = ((t1*t1)+t2);
return {re: (((t0*t1)+t2)/t3), im: (((z_im*t1)-(t0*z_im))/t3)};
})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">compileToComplexFunction</span><span class="params">(code)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The first thing here is a lot of code about &quot;values&quot;. This takes some
explanation.</p>
<p><code>compileToComplexFunction</code> works in three steps.</p>
<ol>
<li><p>It uses <code>parse</code> as its front end. We get an AST that represents
operations on complex numbers.</p>
</li>
<li><p>Then, it <em>lowers</em> the AST to an <em>intermediate representation</em>, or
<em>IR</em> that’s sort of halfway between the AST and JS code.</p>
<p>The IR here is an array of <em>values</em>, basic arithmetic operations on
plain old JS floating-point numbers. If we end up needing JS to
compute `(z_re + 1) * (z_re - 1), then each subexpression there ends
up being a value, represented by an object in the IR.</p>
<p>Once we have the IR, we can throw away the AST. The IR represents the
same formula, but in a different form. Lowering breaks down complex
arithmetic into sequences of JS numeric operations.  JS won’t know
it’s doing complex math.</p>
</li>
<li><p>Lastly, we convert the IR to JS code.</p>
</li>
</ol>
<p><strong>Why IR?</strong> We don’t have to do it this way; we could define a class
<code>Complex</code>, with methods <code>.add()</code>, <code>.sub()</code>, etc., and generate JS code
that uses that.  Our back-end would be less than 20 lines.  But
using IR helps us generate faster JS code. In particular, we’ll avoid
allocating any objects for intermediate results and without any need
for a <code>Complex</code> runtime library.</p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h4>About the IR</h4>
<p>Before we implement lower(), we need to define objects representing
values. (We could just use strings of JS code, but it turns
out to be really complicated, and it’s hard to apply even basic
optimizations to strings.)</p>
<p>We call these instructions &quot;values&quot;.  Each value represents a single JS
expression that evaluates to a number.  A value is one of:</p>
<ol>
<li><code>z_re</code> or <code>z_im</code>, the real or imaginary part of the argument z; or</li>
<li>a numeric constant; or</li>
<li>an arithmetic operation, one of <code>+ - * /</code>, on two previously-
calculated values.</li>
</ol>
<p>And each value is represented by a plain old JSON object, as follows:</p>
<ol>
<li><code>{type: &quot;arg&quot;, arg0: &quot;z_re&quot;</code> or <code>&quot;z_im&quot;}</code></li>
<li><code>{type: &quot;number&quot;, arg0: (string picture of number)}</code></li>
<li><code>{type: (one of &quot;+&quot; &quot;-&quot; &quot;*&quot; &quot;/&quot;), arg0: (int), arg1: (int)}</code></li>
</ol>
<p>All values are stored sequentially in the array <code>values</code>.  The two ints
<code>v.arg0</code> and <code>v.arg1</code> in an arithmetic value are indexes into <code>values</code>.</p>
<p>The main reason to store all values in a flat array, rather than a tree,
is for &quot;common subexpression elimination&quot; (see valueToIndex).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> values = [
        {type: <span class="string">"arg"</span>, arg0: <span class="string">"z_re"</span>, arg1: <span class="literal">null</span>},
        {type: <span class="string">"arg"</span>, arg0: <span class="string">"z_im"</span>, arg1: <span class="literal">null</span>}
    ];</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><code>values(n1, n2)</code> returns true if the two arguments <code>n1</code> and <code>n2</code> are
equal values—that is, if it would be redundant to compute them both,
because they are certain to have the same result.</p>
<p>(This could be more sophisticated; it does not detect, for example, that
a+1 is equal to 1+a.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">valuesEqual</span><span class="params">(n1, n2)</span> {</span>
        <span class="keyword">return</span> n1.type === n2.type &amp;&amp; n1.arg0 === n2.arg0 &amp;&amp; n1.arg1 === n2.arg1;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Return the index of <code>v</code> within <code>values</code>, adding it to <code>values</code> if needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">valueToIndex</span><span class="params">(v)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Common subexpression elimination. If we have already computed this
exact value, instead of computing it again, just reuse the already-
computed value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) {
            <span class="keyword">if</span> (valuesEqual(values[i], v))
                <span class="keyword">return</span> i;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>We have not already computed this value, so add the value to
the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        values.push(v);
        <span class="keyword">return</span> values.length - <span class="number">1</span>;
    }

    <span class="function"><span class="keyword">function</span> <span class="title">num</span><span class="params">(s)</span> {</span>
        <span class="keyword">return</span> valueToIndex({type: <span class="string">"number"</span>, arg0: s, arg1: <span class="literal">null</span>});
    }

    <span class="function"><span class="keyword">function</span> <span class="title">op</span><span class="params">(op, a, b)</span> {</span>
        <span class="keyword">return</span> valueToIndex({type: op, arg0: a, arg1: b });
    }

    <span class="function"><span class="keyword">function</span> <span class="title">isNumber</span><span class="params">(i)</span> {</span>
        <span class="keyword">return</span> values[i].type === <span class="string">"number"</span>;
    }

    <span class="function"><span class="keyword">function</span> <span class="title">isZero</span><span class="params">(i)</span> {</span>
        <span class="keyword">return</span> isNumber(i) &amp;&amp; values[i].arg0 === <span class="string">"0"</span>;
    }

    <span class="function"><span class="keyword">function</span> <span class="title">isOne</span><span class="params">(i)</span> {</span>
        <span class="keyword">return</span> isNumber(i) &amp;&amp; values[i].arg0 === <span class="string">"1"</span>;
    }

    <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(a, b)</span> {</span>
        <span class="keyword">if</span> (isZero(a))  <span class="comment">// simplify (0+b) to b</span>
            <span class="keyword">return</span> b;
        <span class="keyword">if</span> (isZero(b))  <span class="comment">// simplify (a+0) to a</span>
            <span class="keyword">return</span> a;
        <span class="keyword">if</span> (isNumber(a) &amp;&amp; isNumber(b))  <span class="comment">// constant-fold (1+2) to 3</span>
            <span class="keyword">return</span> num(String(Number(values[a].arg0) + Number(values[b].arg0)));
        <span class="keyword">return</span> op(<span class="string">"+"</span>, a, b);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">sub</span><span class="params">(a, b)</span> {</span>
        <span class="keyword">if</span> (isZero(b))  <span class="comment">// simplify (a-0) to a</span>
            <span class="keyword">return</span> a;
        <span class="keyword">if</span> (isNumber(a) &amp;&amp; isNumber(b))  <span class="comment">// constant-fold (3-2) to 1</span>
            <span class="keyword">return</span> num(String(Number(values[a].arg0) - Number(values[b].arg0)));
        <span class="keyword">return</span> op(<span class="string">"-"</span>, a, b);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">mul</span><span class="params">(a, b)</span> {</span>
        <span class="keyword">if</span> (isZero(a))  <span class="comment">// simplify 0*b to 0</span>
            <span class="keyword">return</span> a;
        <span class="keyword">if</span> (isZero(b))  <span class="comment">// simplify a*0 to 0</span>
            <span class="keyword">return</span> b;
        <span class="keyword">if</span> (isOne(a))  <span class="comment">// simplify 1*b to b</span>
            <span class="keyword">return</span> b;
        <span class="keyword">if</span> (isOne(b))  <span class="comment">// simplify a*1 to a</span>
            <span class="keyword">return</span> a;
        <span class="keyword">if</span> (isNumber(a) &amp;&amp; isNumber(b))  <span class="comment">// constant-fold (2*2) to 4</span>
            <span class="keyword">return</span> num(String(Number(values[a].arg0) * Number(values[b].arg0)));
        <span class="keyword">return</span> op(<span class="string">"*"</span>, a, b);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">div</span><span class="params">(a, b)</span> {</span>
        <span class="keyword">if</span> (isOne(b))  <span class="comment">// simplify a/1 to a</span>
            <span class="keyword">return</span> a;
        <span class="keyword">if</span> (isNumber(a) &amp;&amp; isNumber(b) &amp;&amp; !isZero(b))  <span class="comment">// constant-fold 4/2 to 2</span>
            <span class="keyword">return</span> num(String(Number(values[a].arg0) / Number(values[b].arg0)));
        <span class="keyword">return</span> op(<span class="string">"/"</span>, a, b);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Reduce obj, which represents an operation on complex numbers, to a pair
of expressions on floating-point numbers.</p>
<p>As a side effect, this populates the array <code>values</code> with IR objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">ast_to_ir</span><span class="params">(obj)</span> {</span>
        <span class="keyword">switch</span> (obj.type) {
        <span class="keyword">case</span> <span class="string">"number"</span>:
            <span class="keyword">return</span> {re: num(obj.value), im: num(<span class="string">"0"</span>)};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Complex arithmetic. Start by calling <code>ast_to_ir</code> recursively on the
operands. The rest is just standard formulas:</p>
<p>Re(<em>a</em> ± <em>b</em>) = Re(<em>a</em>) ± Re(<em>b</em>)<br>
Im(<em>a</em> ± <em>b</em>) = Im(<em>a</em>) ± Im(<em>b</em>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">case</span> <span class="string">"+"</span>: <span class="keyword">case</span> <span class="string">"-"</span>:
            <span class="keyword">var</span> a = ast_to_ir(obj.left), b = ast_to_ir(obj.right);
            <span class="keyword">var</span> f = (obj.type === <span class="string">"+"</span> ? add : sub);
            <span class="keyword">return</span> {
                re: f(a.re, b.re),
                im: f(a.im, b.im)
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Multiplication:</p>
<p>Re(<em>a</em> × <em>b</em>) = Re(<em>a</em>) × Re(<em>b</em>) − Im(<em>a</em>) × Im(<em>b</em>)<br>
Im(<em>a</em> × <em>b</em>) = Re(<em>a</em>) × Im(<em>b</em>) + Im(<em>a</em>) × Re(<em>b</em>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">case</span> <span class="string">"*"</span>:
            <span class="keyword">var</span> a = ast_to_ir(obj.left), b = ast_to_ir(obj.right);
            <span class="keyword">return</span> {
                re: sub(mul(a.re, b.re), mul(a.im, b.im)),
                im: add(mul(a.re, b.im), mul(a.im, b.re))
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Division:</p>
<p>Re(<em>a</em> ÷ <em>b</em>) = (Re(<em>a</em>) × Re(<em>b</em>) + Im(<em>a</em>) × Im(<em>b</em>)) ÷ <em>t</em><br>
Im(<em>a</em> ÷ <em>b</em>) = (Im(<em>a</em>) × Re(<em>b</em>) − Re(<em>a</em>) × Im(<em>b</em>)) ÷ <em>t</em><br>
where <em>t</em> = Re(<em>b</em>)² + Im(<em>b</em>)²</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">case</span> <span class="string">"/"</span>:
            <span class="keyword">var</span> a = ast_to_ir(obj.left), b = ast_to_ir(obj.right);
            <span class="keyword">var</span> t = add(mul(b.re, b.re), mul(b.im, b.im));
            <span class="keyword">return</span> {
                re: div(add(mul(a.re, b.re), mul(a.im, b.im)), t),
                im: div(sub(mul(a.im, b.re), mul(a.re, b.im)), t)
            };

        <span class="keyword">case</span> <span class="string">"name"</span>:
            <span class="keyword">if</span> (obj.id === <span class="string">"i"</span>)
                <span class="keyword">return</span> {re: num(<span class="string">"0"</span>), im: num(<span class="string">"1"</span>)};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>A little subtle here: <code>values[0]</code> is the IR node for <code>z_re</code>;
<code>values[1]</code> is <code>z_im</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (obj.id === <span class="string">"z"</span>)
                <span class="keyword">return</span> {re: <span class="number">0</span>, im: <span class="number">1</span>};

            <span class="keyword">throw</span> SyntaxError(<span class="string">"undefined variable: "</span> + obj.id);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Figure out how many times each value is used in subsequent calculations.
This is how we avoid emitting all the code for a value every time it is
used. As we generate JS, whenever we reach a value that is used multiple
times, we’ll write out a <code>var</code> statement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">computeUseCounts</span><span class="params">(values)</span> {</span>
        <span class="keyword">var</span> binaryOps = {<span class="string">"+"</span>: <span class="number">1</span>, <span class="string">"-"</span>: <span class="number">1</span>, <span class="string">"*"</span>: <span class="number">1</span>, <span class="string">"/"</span>: <span class="number">1</span>};
        <span class="keyword">var</span> useCounts = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) {
            useCounts[i] = <span class="number">0</span>;
            <span class="keyword">var</span> node = values[i];
            <span class="keyword">if</span> (node.type <span class="keyword">in</span> binaryOps) {
                useCounts[node.arg0]++;
                useCounts[node.arg1]++;
            }
        }
        <span class="keyword">return</span> useCounts;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Step 3: Convert the IR to JavaScript.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">ir_to_js</span><span class="params">(values, result)</span> {</span>
        <span class="keyword">var</span> useCounts = computeUseCounts(values);
        <span class="keyword">var</span> code = <span class="string">""</span>;
        <span class="keyword">var</span> next_temp_id = <span class="number">0</span>;
        <span class="keyword">var</span> js = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) {
            <span class="keyword">var</span> node = values[i];
            <span class="keyword">if</span> (node.type === <span class="string">"number"</span> || node.type === <span class="string">"arg"</span>) {
                js[i] = node.arg0;
            } <span class="keyword">else</span> {
                js[i] = <span class="string">"("</span> + js[node.arg0] + node.type + js[node.arg1] + <span class="string">")"</span>;
                <span class="keyword">if</span> (useCounts[i] &gt; <span class="number">1</span>) {
                    <span class="keyword">var</span> name = <span class="string">"t"</span> + next_temp_id++;
                    code += <span class="string">"var "</span> + name + <span class="string">" = "</span> + js[i] + <span class="string">";\n"</span>;
                    js[i] = name;
                }
            }
        }
        code += <span class="string">"return {re: "</span> + js[result.re] + <span class="string">", im: "</span> + js[result.im] + <span class="string">"};\n"</span>;
        <span class="keyword">return</span> code;
    }

    <span class="keyword">var</span> ast = parse(code);
    <span class="keyword">var</span> result = ast_to_ir(ast);
    <span class="keyword">var</span> code = ir_to_js(values, result);
    console.log(code);
    <span class="keyword">return</span> Function(<span class="string">"z_re, z_im"</span>, code);

    <span class="comment">/*
      I had planned to have this generate asm.js code for extra speed, but it’s
      so fast already that unless I can think of a more computationally
      intensive task, there is no need.
    */</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>The last bit of code here simply stores all seven back ends in one place
where other code can get to them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> parseModes = {
    json: convertToJSON,
    blocks: convertToDOM,
    mathml: convertToMathML,
    calc: evaluateAsFloat,
    fraction: evaluateAsFraction,
    graph: compileToJSFunction,
    complex: compileToComplexFunction
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
